<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Retro DV</title>
    <style>
        :root { --ios-red: #ff3b30; --ios-yellow: #f7d51d; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; font-family: 'Courier New', monospace; overflow: hidden; color: white; -webkit-user-select: none; }
        
        /* é è¦½è¦–çª— */
        #viewport { position: relative; width: 100%; height: 100%; display: flex; align-items: center; background: #000; }
        video#v { width: 100%; height: 100%; object-fit: cover; filter: contrast(1.1) saturate(1.2); transition: transform 0.1s; }

        /* DV å¾©å¤æ¿¾é¡ */
        .dv-overlay { position: absolute; inset: 0; pointer-events: none; z-index: 2; background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%); background-size: 100% 3px; opacity: 0.3; }
        .noise { position: absolute; inset: 0; z-index: 3; pointer-events: none; background: url('https://media.giphy.com/media/oEI9uWUicKgH6/giphy.gif'); opacity: 0.04; mix-blend-mode: screen; }

        /* ä»‹é¢æ–‡å­— */
        .ui-text { position: absolute; color: var(--ios-yellow); text-shadow: 2px 2px #000; z-index: 4; font-weight: bold; pointer-events: none; }
        #rec-indicator { top: 50px; left: 20px; color: var(--ios-red); display: none; animation: blink 1s infinite; font-size: 18px; }
        @keyframes blink { 50% { opacity: 0; } }
        .timestamp { bottom: 180px; left: 20px; font-size: 18px; line-height: 1.2; }

        /* Zoom å´é‚Šæ¢ */
        .zoom-wrap { position: absolute; right: 15px; top: 40%; transform: translateY(-50%); display: flex; flex-direction: column; align-items: center; z-index: 10; font-family: sans-serif; }
        .zoom-slider { appearance: none; -webkit-appearance: none; width: 150px; height: 2px; background: rgba(255,255,255,0.4); transform: rotate(-90deg); margin: 70px 0; outline: none; }
        .zoom-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 26px; height: 26px; border-radius: 50%; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.5); }

        /* æ¨¡å¼åˆ‡æ›å™¨ */
        .mode-selector { position: absolute; bottom: 130px; width: 100%; display: flex; justify-content: center; gap: 40px; z-index: 5; font-family: -apple-system, sans-serif; font-weight: 600; text-shadow: 0 1px 3px rgba(0,0,0,0.8); }
        .mode { color: rgba(255,255,255,0.4); font-size: 14px; transition: 0.2s; padding: 5px 10px; }
        .mode.active { color: var(--ios-yellow); }

        /* åº•éƒ¨æ§åˆ¶æ¬„ */
        .controls { position: absolute; bottom: 0; width: 100%; height: 120px; background: rgba(0,0,0,0.8); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); display: flex; align-items: center; justify-content: space-around; z-index: 5; padding-bottom: env(safe-area-inset-bottom); }
        .btn-side { width: 48px; height: 48px; border-radius: 50%; background: rgba(255,255,255,0.15); border: none; color: white; font-size: 20px; display: flex; align-items: center; justify-content: center; }
        
        .shutter-btn { width: 75px; height: 75px; border-radius: 50%; background: white; padding: 4px; border: none; outline: none; -webkit-tap-highlight-color: transparent; }
        .shutter-inner { width: 100%; height: 100%; border-radius: 50%; transition: 0.2s; }
        .mode-video .shutter-inner { background: var(--ios-red); }
        .mode-photo .shutter-inner { background: white; border: 2px solid #333; }
        .recording .shutter-inner { border-radius: 8px; transform: scale(0.6); }

        /* é è¦½åœ–å±¤ */
        #preview-layer { position: fixed; inset: 0; background: #000; z-index: 1000; display: none; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .preview-media { width: 100%; max-height: 65vh; border-radius: 8px; object-fit: contain; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
    </style>
</head>
<body>

    <div id="viewport">
        <div class="ui-text" id="rec-indicator">â— REC</div>
        <div class="dv-overlay"></div>
        <div class="noise"></div>
        <div class="ui-text timestamp" id="ts"></div>
        
        <video id="v" autoplay playsinline muted></video>

        <div class="zoom-wrap ui-text">
            <span id="zoom-txt">1.0x</span>
            <input type="range" class="zoom-slider" id="z" min="1" max="4" step="0.1" value="1">
            <span>ZOOM</span>
        </div>

        <div class="mode-selector">
            <span class="mode active" id="mode-video" onclick="setMode('video')">VIDEO</span>
            <span class="mode" id="mode-photo" onclick="setMode('photo')">PHOTO</span>
        </div>

        <div class="controls mode-video" id="ctrl-bar">
            <button class="btn-side" onclick="switchCam()">ğŸ”„</button>
            <button class="shutter-btn" id="shutter-trigger">
                <div class="shutter-inner" id="shutter-ui"></div>
            </button>
            <button class="btn-side">ğŸï¸</button>
        </div>
    </div>

    <div id="preview-layer">
        <div id="media-container" style="width: 100%; display: flex; justify-content: center;"></div>
        <div style="text-align: center; margin: 25px 0;">
            <p style="color: var(--ios-yellow); font-size: 16px; margin: 0; font-weight: bold;">é•·æŒ‰ä¸Šæ–¹å…§å®¹å„²å­˜è‡³ç›¸ç°¿</p>
            <p style="color: #666; font-size: 12px; margin: 5px 0;">LONG PRESS TO SAVE VIDEO/PHOTO</p>
        </div>
        <button onclick="closePreview()" style="background: white; color: black; border: none; padding: 12px 50px; border-radius: 25px; font-weight: bold; font-family: sans-serif; font-size: 16px;">è¿”å› BACK</button>
    </div>

    <script>
        const v = document.getElementById('v');
        const ts = document.getElementById('ts');
        const z = document.getElementById('z');
        const zTxt = document.getElementById('zoom-txt');
        const ctrlBar = document.getElementById('ctrl-bar');
        const shutter = document.getElementById('shutter-trigger');
        
        let currentMode = 'video';
        let facingMode = "environment";
        let recorder, chunks = [], isRec = false;

        async function init() {
            if(window.stream) window.stream.getTracks().forEach(t => t.stop());
            try {
                const s = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: facingMode, width: { ideal: 1280 }, height: { ideal: 720 } }, 
                    audio: true 
                });
                v.srcObject = s;
                window.stream = s;
            } catch (e) { alert("è«‹ç¢ºä¿ Safari å·²æˆæ¬Šç›¸æ©Ÿæ¬Šé™"); }
        }

        function setMode(m) {
            if (isRec) return;
            currentMode = m;
            document.querySelectorAll('.mode').forEach(el => el.classList.remove('active'));
            document.getElementById(`mode-${m}`).classList.add('active');
            ctrlBar.className = `controls mode-${m}`;
        }

        shutter.onclick = () => {
            if (currentMode === 'video') toggleRec();
            else takePhoto();
        };

        function takePhoto() {
            const canvas = document.createElement('canvas');
            canvas.width = v.videoWidth; canvas.height = v.videoHeight;
            const ctx = canvas.getContext('2d');
            
            // è™•ç† Zoom å¾Œçš„æ‹ç…§ç•«é¢
            const scale = parseFloat(z.value);
            const sw = v.videoWidth / scale;
            const sh = v.videoHeight / scale;
            const sx = (v.videoWidth - sw) / 2;
            const sy = (v.videoHeight - sh) / 2;
            
            ctx.drawImage(v, sx, sy, sw, sh, 0, 0, canvas.width, canvas.height);
            showPreview(canvas.toDataURL('image/jpeg'), 'photo');
        }

        function toggleRec() {
            if (!isRec) {
                chunks = [];
                // é‡å° iOS å„ªåŒ–çš„ MediaRecorder è¨­å®š
                const options = { mimeType: 'video/mp4' };
                recorder = new MediaRecorder(window.stream, options);
                
                recorder.ondataavailable = e => { if(e.data.size > 0) chunks.push(e.data); };
                recorder.onstop = () => {
                    const blob = new Blob(chunks, { type: 'video/mp4' });
                    const videoURL = URL.createObjectURL(blob);
                    showPreview(videoURL, 'video');
                };

                recorder.start();
                document.getElementById('rec-indicator').style.display = 'block';
                ctrlBar.classList.add('recording');
                isRec = true;
            } else {
                recorder.stop();
                document.getElementById('rec-indicator').style.display = 'none';
                ctrlBar.classList.remove('recording');
                isRec = false;
            }
        }

        function showPreview(url, type) {
            const container = document.getElementById('media-container');
            if (type === 'video') {
                // é—œéµï¼šåœ¨é è¦½ä¸­ä½¿ç”¨åŸç”Ÿ controlsï¼Œé€™æ¨£ iOS é•·æŒ‰æ‰æœ‰åæ‡‰
                container.innerHTML = `<video src="${url}" class="preview-media" controls playsinline autoplay loop webkit-playsinline></video>`;
            } else {
                container.innerHTML = `<img src="${url}" class="preview-media">`;
            }
            document.getElementById('preview-layer').style.display = 'flex';
        }

        function closePreview() {
            document.getElementById('preview-layer').style.display = 'none';
            document.getElementById('media-container').innerHTML = '';
            // é‡‹æ”¾è¨˜æ†¶é«”é¿å…å¡é “
            if (currentMode === 'video' && container.querySelector('video')) {
                URL.revokeObjectURL(container.querySelector('video').src);
            }
        }

        function switchCam() {
            facingMode = (facingMode === "environment") ? "user" : "environment";
            init();
        }

        z.oninput = () => {
            v.style.transform = `scale(${z.value})`;
            zTxt.innerText = `${parseFloat(z.value).toFixed(1)}x`;
        };

        setInterval(() => {
            const d = new Date();
            const m = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
            ts.innerHTML = `${m[d.getMonth()]} ${String(d.getDate()).padStart(2,'0')} ${d.getFullYear()}<br>${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}:${String(d.getSeconds()).padStart(2,'0')}`;
        }, 1000);

        init();
    </script>
</body>
</html>
